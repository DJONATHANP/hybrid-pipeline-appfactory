name: Pipeline CI/CD Híbrido

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecución manual

env:
  AWS_REGION: us-east-1 # Define la región de AWS
  # Pasamos la API key a Terraform como variable de entorno TF_VAR
  TF_VAR_lambda_api_key: ${{ secrets.API_GATEWAY_KEY }}

jobs:
  hybrid_deploy:
    runs-on: ubuntu-latest # Se ejecuta en un runner de GitHub
    outputs:
      api_gateway_endpoint: ${{ steps.get_output.outputs.api_endpoint }}

    steps:
      - name: Checkout del Codigo
        uses: actions/checkout@v4

      # =========================================================
      # 1. AWS - Despliegue de Infraestructura (Terraform)
      # =========================================================
      - name: Configurar Credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Inicializar Terraform
        run: terraform init
        working-directory: ./infra-aws

      - name: Aplicar Terraform (Desplegar Lambda y API Gateway)
        id: apply_tf
        run: terraform apply -auto-approve
        working-directory: ./infra-aws
      
      - name: Obtener Output del API Gateway Endpoint
        id: get_output
        run: |
          # Captura el output de Terraform
          API_ENDPOINT=$(terraform output -raw api_gateway_endpoint)
          echo "API_GATEWAY_ENDPOINT=$API_ENDPOINT" >> $GITHUB_ENV
          # Exponer como output del job para otros jobs
          echo "api_endpoint=$API_ENDPOINT" >> $GITHUB_OUTPUT
        working-directory: ./infra-aws

      # =========================================================
      # 2. Local - Despliegue y Configuracion (Ansible + Docker)
      # =========================================================
      - name: Configurar Ansible
        uses: dawidd6/action-ansible-playbook@v2
        with:
          # CORRECCIÓN DEFINITIVA: Solo el parámetro obligatorio con valor vacío.
          playbook: "" 

      - name: 2.1. Construir la Imagen del Frontend
        run: docker build -t appfactory/frontend:${{ github.sha }} ./frontend
      
      - name: 2.2. Login en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: 2.3. Push de la Imagen del Frontend a Docker Hub
        run: docker push appfactory/frontend:${{ github.sha }}

      - name: 2.4. Simulación de Ejecución de Ansible Local
        run: |
          echo "Simulando ejecución de Ansible en el host local..."
          # Usamos ${{ env.API_GATEWAY_ENDPOINT }} para la URL obtenida del output de Terraform
          echo "Ejecutaría: ansible-playbook config-local/deploy-local.yml -e api_gateway_url=${{ env.API_GATEWAY_ENDPOINT }} -e api_gateway_key=${{ secrets.API_GATEWAY_KEY }} -e frontend_image=appfactory/frontend:${{ github.sha }}"
          echo "---"
          echo "El host local haría:"
          echo "1. docker pull appfactory/frontend:${{ github.sha }}"
          echo "2. Reemplazaría API_GATEWAY_URL y API_GATEWAY_KEY en docker-compose.yml"
          echo "3. docker compose up -d --force-recreate nginx-proxy"

  local_deploy:
    name: Despliegue Local (Self-Hosted)
    needs: hybrid_deploy
    runs-on: self-hosted
    steps:
      - name: Checkout del Codigo
        uses: actions/checkout@v4
      - name: Ejecutar Ansible en host local
        run: |
          ansible-playbook config-local/deploy-local.yml \
            -e api_gateway_url=${{ needs.hybrid_deploy.outputs.api_gateway_endpoint }} \
            -e api_gateway_key='${{ secrets.API_GATEWAY_KEY }}' \
            -e frontend_image=appfactory/frontend:${{ github.sha }}