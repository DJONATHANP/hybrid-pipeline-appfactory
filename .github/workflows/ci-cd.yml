name: Pipeline CI/CD Híbrido

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite ejecución manual

env:
  AWS_REGION: us-east-1 # Define la región de AWS

jobs:
  hybrid_deploy:
    runs-on: ubuntu-latest # Se ejecuta en un runner de GitHub

    steps:
      - name: Checkout del Codigo
        uses: actions/checkout@v4

      # =========================================================
      # 1. AWS - Despliegue de Infraestructura (Terraform)
      # =========================================================
      - name: Configurar Credenciales de AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Inicializar Terraform
        run: terraform init
        working-directory: ./infra-aws

      - name: Aplicar Terraform (Desplegar Lambda y API Gateway)
        id: apply_tf
        run: terraform apply -auto-approve
        working-directory: ./infra-aws
      
      - name: Obtener Output del API Gateway Endpoint
        id: get_output
        run: |
          # Captura el output de Terraform
          API_ENDPOINT=$(terraform output -raw api_gateway_endpoint)
          # Exporta la variable para que esté disponible en 'env' para el resto de los pasos
          echo "API_GATEWAY_ENDPOINT=$API_ENDPOINT" >> $GITHUB_ENV
        working-directory: ./infra-aws

      # =========================================================
      # 2. Local - Despliegue y Configuracion (Ansible + Docker)
      # =========================================================
      - name: Configurar Ansible
        uses: dawidd6/action-ansible-playbook@v2
        with:
          # CORRECCIÓN: Usamos este parámetro no conflictivo para que la acción no pida 'playbook'.
          requirements: "" 

      - name: 2.1. Construir la Imagen del Frontend
        run: docker build -t appfactory/frontend:${{ github.sha }} ./frontend
      
      - name: 2.2. Login en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: 2.3. Push de la Imagen del Frontend a Docker Hub
        run: docker push appfactory/frontend:${{ github.sha }}

      - name: 2.4. Simulación de Ejecución de Ansible Local
        run: |
          echo "Simulando ejecución de Ansible en el host local..."
          # Usamos ${{ env.API_GATEWAY_ENDPOINT }} para la URL obtenida del output de Terraform
          echo "Ejecutaría: ansible-playbook config-local/deploy-local.yml -e api_gateway_url=${{ env.API_GATEWAY_ENDPOINT }} -e frontend_image=appfactory/frontend:${{ github.sha }}"
          echo "---"
          echo "El host local haría:"
          echo "1. docker pull appfactory/frontend:${{ github.sha }}"
          echo "2. Reemplazaría API_GATEWAY_URL en docker-compose.yml con: ${{ env.API_GATEWAY_ENDPOINT }}"
          echo "3. docker compose up -d --force-recreate nginx-proxy"

          echo "2. Reemplazaría API_GATEWAY_URL en docker-compose.yml con: ${{ env.API_GATEWAY_ENDPOINT }}"
          echo "3. docker compose up -d --force-recreate nginx-proxy"