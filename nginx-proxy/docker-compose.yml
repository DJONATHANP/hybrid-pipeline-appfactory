version: '3.8'

services:
  # 1. Servicio del Frontend (servido por su propio NGINX en la imagen)
  frontend:
    image: pp09020/appfactory-frontend:latest # Imagen en tu namespace de Docker Hub
    container_name: appfactory_frontend
    # Permite al servicio 'nginx-proxy' acceder a este servicio por el nombre 'frontend'
    expose:
      - 80 
    ports:
      - "8090:80"
    restart: unless-stopped
    networks:
      - app-net

  # 2. Servicio de Reverse Proxy
  nginx-proxy:
    image: nginx:alpine
    container_name: appfactory_proxy
    ports:
      - "8080:80" 
    # *** CAMBIO AQU√ç ***
    volumes:
      # Monta nginx.conf como plantilla; el entrypoint de nginx hara envsubst a conf.d
      - ./nginx.conf:/etc/nginx/templates/default.conf.template:ro 
    # *******************
    environment:
      # Valor placeholder. Terraform/Ansible lo reemplazaran
      API_GATEWAY_URL: "0j59huq5h0.execute-api.us-east-1.amazonaws.com"
      API_GATEWAY_KEY: "TEST-KEY-123"
    depends_on:
      - frontend # Asegura que el frontend este arriba antes que el proxy
    restart: unless-stopped
    networks:
      - app-net

networks:
  app-net:
    driver: bridge